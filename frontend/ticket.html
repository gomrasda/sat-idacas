<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tickets del Aviso</title>
  <style>
    :root{
      --b:#e9eef6; --bg:#f5f7fb; --ink:#1f2937; --muted:#6b7280; --chip:#eef2f7;
      --card-b:#cfd8e6; --alt-bg:#f6f8fb;
    }
    body { margin: 0; font-family: Arial, sans-serif; background: var(--bg); color: var(--ink); }
    .container { max-width: 980px; margin: auto; padding: 16px; }
    h2 { margin-top: 0; text-align: center; }
    label, select, input { display: block; width: 100%; margin: 10px 0; }
    .btn { background: #007bff; color: white; border: none; padding: 10px 16px; margin-top: 10px; cursor: pointer; border-radius: 5px; }
    .btn:hover { background: #0056b3; }

    .table-wrap { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow-x:auto; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #f7f9fc; font-weight: 600; color: #4a5568; }

    /* Forzar may√∫sculas al t√≠tulo principal */
    #tituloCliente { text-transform: uppercase; }

    /* Base inputs escritorio */
    input, select, textarea, button { font-size:16px; }
    td input, td select, td textarea{
      width:100%; font:inherit; padding:8px; border:1px solid var(--b); border-radius:8px; background:#fff
    }

    /* TEXTAREA: autoajuste sin scroll (escritorio) */
    td textarea{
      resize: none;          /* sin tirador */
      overflow: hidden;      /* sin scroll interno */
      min-height: 56px;      /* alto m√≠nimo */
      line-height: 1.4;
    }

    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px;
      z-index: 1000; width: 90%; max-width: 420px;
    }
    .modal input, .modal select, .modal textarea { width: 100%; margin: 8px 0; padding: 8px; }

    /* ====== BARRA SUPERIOR / TOGGLE DE VISTA ====== */
    .actions-row{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; margin: 8px 0 14px;
      align-items:center;
    }
    .view-toggle{
      display:flex; align-items:center; gap:8px; margin-left:auto;
      font-size:14px; color:#4b5563;
    }
    .switch{
      position:relative; width:46px; height:26px; background:#cfd8e6; border-radius:999px; cursor:pointer; flex-shrink:0;
    }
    .switch input{ display:none; }
    .switch span{
      position:absolute; top:3px; left:3px; width:20px; height:20px; background:white; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,.2); transition:all .2s;
    }
    .switch input:checked + span{ transform:translateX(20px); background:white; }
    .switch input:checked ~ .track{ background:#007bff; }
    .track{ position:absolute; inset:0; border-radius:999px; background:#cfd8e6; transition:background .2s; }

    /* ====== VISTA TARJETAS TAMBI√âN EN ESCRITORIO ====== */
    /* Cuando el body tenga la clase .cards ocultar cabecera y renderizar como en m√≥vil (con tama√±os razonables) */
    body.cards thead { display: none; }
    body.cards #ticketsBody tr { border:0; }

    body.cards #ticketsBody tr.r1,
    body.cards #ticketsBody tr.r2,
    body.cards #ticketsBody tr.r3,
    body.cards #ticketsBody tr.r4{
      display:grid; gap:10px; padding:12px;
      background:#fff; border:2px solid var(--card-b);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    body.cards #ticketsBody tr.r1{ grid-template-columns: 1fr 1fr; border-bottom:0; border-radius:12px 12px 0 0; margin-top:14px; }
    body.cards #ticketsBody tr.r2{ grid-template-columns: 1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r3{ grid-template-columns: 1fr 1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r4{ grid-template-columns: 0.7fr auto; border-top:0; border-radius:0 0 12px 12px; margin-bottom:14px; }
    body.cards #ticketsBody tr.alt { background: var(--alt-bg); }

    body.cards #ticketsBody td{
      display:flex; flex-direction: column; align-items:flex-start;
      gap:6px; padding:0; border:0;
    }
    body.cards #ticketsBody td::before{
      content:attr(data-label);
      font-weight:600; color:#6b7280;
      font-size:14px;
      margin-bottom: 2px;
    }
    body.cards #ticketsBody tr.r1 .chip{
      display:flex; align-items:center;
      background:var(--chip); border:1px solid var(--b);
      padding:8px 12px; border-radius:999px;
      height:36px; white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis;
      font-size:14px;
    }
    body.cards #ticketsBody tr.r1 select {
      height: 38px; padding: 8px 12px;
    }
    /* Descripci√≥n m√°s alta + sin scroll en tarjetas escritorio */
    body.cards #ticketsBody tr.r2 textarea,
    body.cards #ticketsBody tr.r2 textarea:disabled {
      min-height: 140px;
      padding: 12px 14px;
      line-height: 1.4;
      font-family: inherit !important;
      background-color: #fff;
      opacity: 1;
      resize: none;
      overflow: hidden;
    }
    body.cards #ticketsBody tr.r3 td input{
      background:var(--chip);
      border:1px solid var(--b);
      border-radius:10px;
      padding:12px 14px;
      height:40px;
      text-align:center;
      width:100%;
      font-weight:600;
    }
    body.cards #ticketsBody tr.r4 select{
      min-height: 44px;
      padding: 10px 12px;
      width:100%;
      line-height: 1.3;
      border-radius: 10px;
    }
    body.cards #ticketsBody td.acciones{
      display:flex; flex-direction: row; align-items:center; justify-content:flex-end; gap:8px;
    }
    body.cards #ticketsBody td.acciones button{
      width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--b); background:#fff; border-radius:10px; cursor:pointer;
    }

    /* ====== M√ìVIL/TABLET ====== */
    @media (max-width: 1024px){
      .container { max-width: 100%; padding: 12px; }

      /* T√≠tulo MUY grande */
      #tituloCliente{
        font-size: 54px !important;
        line-height: 1.2;
        margin: 8px 0 22px;
        text-align: center;
        font-weight: 800;
      }

      #btnNuevo, #btnVolver{
        flex:1 1 48%;
        font-size: 40px !important;
        padding: 14px 28px;
        border-radius: 12px;
      }
      #btnVolver{ background:#6c757d; }

      .container > label { font-size: 32px; font-weight: 600; color: var(--muted); margin-bottom:6px; }
      #filtroEstado{
        font-size: 40px !important;
        height: 64px;
        padding: 10px 16px;
        border-radius: 12px;
      }

      /* Tarjetas m√≥vil: usamos la misma estructura que en .cards */
      thead { display: none; }
      #ticketsBody tr { border:0; }

      #ticketsBody tr.r1, #ticketsBody tr.r2, #ticketsBody tr.r3, #ticketsBody tr.r4{
        display:grid; gap:10px; padding:12px;
        background:#fff; border:2px solid var(--card-b);
        box-shadow:0 2px 8px rgba(0,0,0,.06);
      }
      #ticketsBody tr.r1{ grid-template-columns: 1fr 1fr; border-bottom:0; border-radius:12px 12px 0 0; margin-top:14px; }
      #ticketsBody tr.r2{ grid-template-columns: 1fr; border-top:0; border-bottom:0; }
      #ticketsBody tr.r3{ grid-template-columns: 1fr 1fr; border-top:0; border-bottom:0; }
      #ticketsBody tr.r4{ grid-template-columns: 0.6fr auto; border-top:0; border-radius:0 0 12px 12px; margin-bottom:14px; }
      #ticketsBody tr.alt { background: var(--alt-bg); }

      #ticketsBody td{
        display:flex; flex-direction: column; align-items:flex-start;
        gap:4px; padding:0; border:0;
      }
      #ticketsBody td::before{
        content:attr(data-label);
        font-weight:600; color:#6b7280;
        font-size:40px;
        margin-bottom: 2px;
      }

      #ticketsBody tr.r1 .chip{
        display:flex; align-items:center;
        background:var(--chip); border:1px solid var(--b);
        padding:10px 16px; border-radius:999px;
        height:52px; white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis;
        font-size: 40px !important;
      }
      #ticketsBody tr.r1 select {
        font-size: 40px !important;
        height: 52px;
        padding: 10px 16px;
      }

      #ticketsBody tr.r2 textarea,
      #ticketsBody tr.r2 textarea:disabled {
        min-height: 220px;
        padding: 14px 16px;
        font-size: 35px !important;
        line-height: 1.4;
        font-family: inherit !important;
        font-weight: inherit !important;
        color: var(--ink);
        background-color: #fff;
        opacity: 1;
        resize: none;
        overflow: hidden;
      }

      #ticketsBody tr.r3 td input{
        background:var(--chip);
        border:1px solid var(--b);
        border-radius:10px;
        padding:14px 16px;
        height:54px;
        text-align:center;
        width:100%;
        font-size: 40px !important;
        font-weight: 600;
      }

      #ticketsBody tr.r4 select{
        font-size: 40px !important;
        min-height: 70px;
        padding: 16px 18px;
        width:100%;
        line-height: 1.4;
        border-radius: 12px;
      }

      #ticketsBody td.acciones{
        display:flex; flex-direction: row; align-items:center; justify-content:flex-end; gap:10px;
      }
      #ticketsBody td.acciones button{
        width:52px; height:52px; font-size: 40px;
        display:inline-flex; align-items:center; justify-content:center;
        border:1px solid var(--b); background:#fff; border-radius:14px; cursor:pointer;
      }
    }
  </style>
</head>
<body class="cards"><!-- por defecto activamos tarjetas en escritorio -->

<div class="container">
  <h2 id="tituloCliente">Tickets del Aviso</h2>

  <label>Filtrar por Estado:</label>
  <select id="filtroEstado" onchange="cargarTickets()">
    <option value="Todos">Todos</option>
    <option value="Pausado">Pausado</option>
    <option value="Cerrado">Cerrado</option>
    <option value="Facturado">Facturado</option>
  </select>

  <!-- Botones: Crear y Volver + toggle vista -->
  <div class="actions-row">
    <div style="display:flex; gap:12px;">
      <button class="btn" id="btnNuevo">‚ûï Crear Ticket</button>
      <button class="btn" id="btnVolver">üîô Volver a Avisos</button>
    </div>
    <div class="view-toggle" title="Cambiar entre Tarjetas y Tabla">
      <span id="labelVista">Vista: Tarjetas</span>
      <label class="switch">
        <input id="toggleVista" type="checkbox" checked>
        <span></span>
        <div class="track"></div>
      </label>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Fecha</th><th>T√©cnico</th><th>Horas</th><th>Materiales</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th></tr>
      </thead>
      <tbody id="ticketsBody"></tbody>
    </table>
  </div>
</div>

<div id="modal" style="display:none;"></div>

<script>
/* ================== API / AUTH ================== */
const api = "https://sat-idacas.onrender.com/api";
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';

const headers = {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer ' + token
};

const urlParams = new URLSearchParams(window.location.search);
const avisoId = parseInt(urlParams.get('avisoId'), 10);

let tecnicos = [];
let ticketsLista = [];

/* ================== UTIL: fetch con control de errores ================== */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, options);
  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    console.error('API error', res.status, url, txt);
    throw new Error(`API ${res.status}: ${url} -> ${txt}`);
  }
  try { return await res.json(); } catch { return null; }
}

/* ================== AUTO-RESIZE TEXTAREAS ================== */
function autoResize(el) {
  if (!el) return;
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}
function ajustarTodos() {
  document.querySelectorAll('textarea').forEach(autoResize);
}
document.addEventListener('input', (e) => {
  if (e.target && e.target.tagName === 'TEXTAREA') autoResize(e.target);
});

/* ================== DATOS INICIALES ================== */
async function cargarTecnicos() {
  const usuarios = await apiFetch(api + '/usuarios', { headers });
  tecnicos = (usuarios || []).filter(u => u.rol === 'T√©cnico' || u.rol === 'tecnico');
}

async function cargarTitulo(){
  try {
    const aviso = await apiFetch(`${api}/avisos/${avisoId}`, { headers });
    document.getElementById('tituloCliente').innerText =
      aviso && aviso.cliente ? ("Tickets de " + aviso.cliente) : ("Tickets del Aviso (ID: " + avisoId + ")");
  } catch(e){
    console.error("Error cargando t√≠tulo:", e);
    document.getElementById('tituloCliente').innerText = "Tickets del Aviso (ID: "+avisoId+")";
  }
}

document.getElementById('btnNuevo').addEventListener('click', async () => {
  await cargarTecnicos();
  abrirModal();
});
document.getElementById('btnVolver').addEventListener('click', () => {
  window.location.href = 'index.html#avisos';
});

/* ======= TOGGLE VISTA TARJETAS/TABLA ======= */
const toggleVista = document.getElementById('toggleVista');
const labelVista = document.getElementById('labelVista');
function aplicarVista(){
  if (toggleVista.checked) {
    document.body.classList.add('cards');
    labelVista.textContent = 'Vista: Tarjetas';
  } else {
    document.body.classList.remove('cards');
    labelVista.textContent = 'Vista: Tabla';
  }
  cargarTickets();
}
toggleVista.addEventListener('change', aplicarVista);

/* ================== ACTUALIZAR CAMPOS EN L√çNEA ================== */
async function actualizarCampo(id, campo, valor){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;

  const payload = {
    fecha: t.fecha || null,
    tecnico: t.tecnico || "",
    horas_totales: Number(t.horas_totales) || 0,
    precio_materiales: Number(t.precio_materiales) || 0,
    estado: t.estado || "Pausado",
    description: t.description ?? t.descripcion ?? ""
  };

  if (['horas_totales','precio_materiales'].includes(campo)) {
    payload[campo] = parseFloat(valor) || 0;
  } else if (campo === 'description') {
    payload.description = (valor ?? "") + "";
  } else {
    payload[campo] = valor;
  }

  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT',
    headers,
    body: JSON.stringify(payload)
  });

  Object.assign(t, payload);
}

/* ================== RENDER TICKETS ================== */
async function cargarTickets() {
  const tickets = await apiFetch(`${api}/tickets?aviso_id=${avisoId}`, { headers });
  ticketsLista = tickets || [];

  const body = document.getElementById('ticketsBody');
  const filtro = document.getElementById('filtroEstado').value;
  body.innerHTML = "";

  const forceMobile = new URLSearchParams(location.search).get('mobile') === '1';
  const isNarrow = forceMobile || window.matchMedia('(max-width: 1024px)').matches;

  // ¬øUsamos tarjetas? -> en m√≥vil siempre s√≠; en escritorio depende del toggle
  const useCards = isNarrow || toggleVista.checked;

  // Ordenar por fecha (desc)
  const sorted = ticketsLista.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  sorted
    .filter(t => filtro === "Todos" || t.estado === filtro)
    .forEach((t, idx) => {
      const editable = t.estado === "Pausado";
      const disabledCampos = editable ? "" : "disabled";
      const disabledEstado = "";
      const fechaFormateada = t.fecha
        ? new Date(t.fecha).toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric' })
        : "";
      const desc = (t.description ?? t.descripcion ?? "");
      const alt = (idx % 2 ? ' alt' : '');

      if (!useCards) {
        /* ====== TABLA (vista cl√°sica) ====== */
        body.innerHTML += `
          <tr>
            <td>${fechaFormateada}</td>
            <td>${t.tecnico || ""}</td>
            <td>
              <input data-field="horas_totales" type="number"
                     value="${t.horas_totales ?? 0}"
                     onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}>
            </td>
            <td>
              <input data-field="precio_materiales" type="number"
                     value="${t.precio_materiales ?? 0}"
                     onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}>
            </td>
            <td>
              <select onchange="cambiarEstadoTicket(${t.id}, this.value, this)" ${disabledEstado}>
                <option value="Pausado"   ${t.estado==="Pausado"?"selected":""}>Pausado</option>
                <option value="Cerrado"   ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
                <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
              </select>
            </td>
            <td>
              <textarea data-field="description"
                        onchange="actualizarCampo(${t.id},'description',this.value)" ${disabledCampos}>${desc}</textarea>
            </td>
            <td>
              <button onclick='editarTicket(${t.id})' title="Editar">‚úèÔ∏è</button>
              <button onclick="borrarTicket(${t.id})" title="Borrar">üóëÔ∏è</button>
            </td>
          </tr>`;
      } else {
        /* ====== TARJETAS (igual que m√≥vil, tambi√©n en PC) ====== */
        body.innerHTML += `
          <tr class="r1${alt}" data-id="${t.id}">
            <td data-label="Fecha"><span class="chip">${fechaFormateada}</span></td>
            <td data-label="T√©cnico"><span class="chip">${t.tecnico || ""}</span></td>
          </tr>

          <tr class="r2${alt}" data-id="${t.id}">
            <td class="desc" data-label="Descripci√≥n">
              <textarea data-field="description"
                        onchange="actualizarCampo(${t.id},'description',this.value)" ${disabledCampos}>${desc}</textarea>
            </td>
          </tr>

          <tr class="r3${alt}" data-id="${t.id}">
            <td class="horas" data-label="Horas">
              <input data-field="horas_totales" type="number" step="0.1" min="0"
                     value="${t.horas_totales ?? 0}"
                     onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}>
            </td>
            <td class="materiales" data-label="Materiales">
              <input data-field="precio_materiales" type="number" step="0.01" min="0"
                     value="${t.precio_materiales ?? 0}"
                     onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}>
            </td>
          </tr>

          <tr class="r4${alt}" data-id="${t.id}">
            <td class="estado" data-label="Estado">
              <select onchange="cambiarEstadoTicket(${t.id}, this.value, this)" ${disabledEstado}>
                <option value="Pausado"   ${t.estado==="Pausado"?"selected":""}>Pausado</option>
                <option value="Cerrado"   ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
                <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
              </select>
            </td>
            <td class="acciones" data-label="Acciones">
              <button onclick='editarTicket(${t.id})' title="Editar">‚úèÔ∏è</button>
              <button onclick="borrarTicket(${t.id})" title="Borrar">üóëÔ∏è</button>
            </td>
          </tr>`;
      }
    });

  ajustarTodos(); // autoajuste de descripciones
}

// Re-render al cambiar tama√±o/orientaci√≥n
window.addEventListener('resize', () => {
  clearTimeout(window._rt);
  window._rt = setTimeout(cargarTickets, 150);
});

/* ================== MODAL NUEVO TICKET ================== */
function abrirModal(){
  const modal = document.getElementById("modal");
  modal.innerHTML = `
    <div class='modal'>
      <h3>Nuevo Ticket</h3>
      <input id='fecha' type='date' required><br>
      <select id='tecnico'>
        ${tecnicos.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join("")}
      </select><br>
      <input id='horas_totales' type='number' placeholder='Horas Totales' min='0' step='0.1'><br>
      <input id='precio_materiales' type='number' placeholder='Precio Materiales' min='0' step='0.01'><br>
      <select id='estado'>
        <option value="Pausado">Pausado</option>
        <option value="Cerrado">Cerrado</option>
        <option value="Facturado">Facturado</option>
      </select><br><br>
      <textarea id='descripcion' placeholder='Descripci√≥n' rows="3" style="resize:none; overflow:hidden;"></textarea><br><br>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button onclick='guardarTicket()' class="btn">Guardar</button>
        <button onclick='cerrarModal()' class="btn" style="background:#6c757d;">Cancelar</button>
      </div>
    </div>`;
  modal.style.display = "block";
  setTimeout(() => autoResize(document.getElementById('descripcion')), 0);
}

function cerrarModal(){
  document.getElementById("modal").style.display = "none";
}

async function guardarTicket(){
  const data = {
    aviso_id: avisoId,
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value
  };

  await apiFetch(`${api}/tickets`, {
    method: 'POST',
    headers,
    body: JSON.stringify(data)
  });
  cerrarModal();
  cargarTickets();
}

/* ================== BORRAR / CAMBIAR ESTADO ================== */
async function borrarTicket(id){
  if (confirm("¬øEliminar ticket?")) {
    await apiFetch(`${api}/tickets/${id}`, { method: 'DELETE', headers });
    cargarTickets();
  }
}

async function cambiarEstadoTicket(id, nuevoEstado, selectEl){
  try {
    const t = ticketsLista.find(x => x.id === id);
    if (!t) return;

    let desc = t.description ?? t.descripcion ?? "";
    let horas = t.horas_totales ?? 0;
    let mats  = t.precio_materiales ?? 0;

    if (selectEl) {
      const ticketIdAttr = selectEl.closest('tr')?.dataset?.id;
      if (ticketIdAttr) {
        const scope = document.querySelectorAll(`#ticketsBody tr[data-id="${ticketIdAttr}"] [data-field]`);
        scope.forEach(el => {
          if (el.dataset.field === 'description') desc = el.value ?? desc;
          if (el.dataset.field === 'horas_totales') horas = parseFloat(el.value) || horas;
          if (el.dataset.field === 'precio_materiales') mats = parseFloat(el.value) || mats;
        });
      } else {
        const tr  = selectEl.closest('tr');
        const dEl = tr.querySelector('[data-field="description"]');
        const hEl = tr.querySelector('[data-field="horas_totales"]');
        const mEl = tr.querySelector('[data-field="precio_materiales"]');
        if (dEl) desc  = dEl.value ?? desc;
        if (hEl) horas = parseFloat(hEl.value) || horas;
        if (mEl) mats  = parseFloat(mEl.value) || mats;
      }
    }

    if ((nuevoEstado === 'Cerrado' || nuevoEstado === 'Facturado') && (!horas || horas <= 0)) {
      alert('No puedes cerrar o facturar un ticket sin horas.');
      if (selectEl) selectEl.value = t.estado;
      return;
    }

    const payload = {
      fecha: t.fecha || null,
      tecnico: t.tecnico || "",
      horas_totales: horas,
      precio_materiales: mats,
      estado: t.estado,
      description: (desc ?? "") + ""
    };
    await apiFetch(`${api}/tickets/${id}`, { method: 'PUT', headers, body: JSON.stringify(payload) });
    Object.assign(t, payload);

    await apiFetch(`${api}/tickets/${id}/estado`, {
      method: 'PUT',
      headers,
      body: JSON.stringify({ estado: nuevoEstado })
    });

  } catch (e) {
    alert('No se pudo cambiar el estado. Revisa la consola.');
    if (selectEl) {
      const t = ticketsLista.find(x => x.id === id);
      if (t) selectEl.value = t.estado;
    }
  } finally {
    cargarTickets();
  }
}

/* ================== EDITAR TICKET ================== */
async function editarTicket(id) {
  await cargarTecnicos();
  const t = ticketsLista.find(ticket => ticket.id === id);
  if (!t) return alert("No se encontr√≥ el ticket");

  const esPausado = t.estado === 'Pausado';
  const disabledCampos = esPausado ? "" : "disabled";

  const modal = document.getElementById("modal");
  modal.innerHTML = `
    <div class='modal'>
      <h3>Editar Ticket</h3>

      <label>Fecha</label>
      <input id='fecha' type='date' value='${t.fecha ?? ""}' ${disabledCampos}><br>

      <label>T√©cnico</label>
      <select id='tecnico' ${disabledCampos}>
        ${tecnicos.map(te => `<option value="${te.nombre}" ${te.nombre === t.tecnico ? 'selected' : ''}>${te.nombre}</option>`).join("")}
      </select><br>

      <label>Horas Totales</label>
      <input id='horas_totales' type='number' value='${t.horas_totales || 0}' min='0' step='0.1' ${disabledCampos}><br>

      <label>Precio Materiales</label>
      <input id='precio_materiales' type='number' value='${t.precio_materiales || 0}' min='0' step='0.01' ${disabledCampos}><br>

      <label>Estado</label>
      <select id='estado'>
        <option value="Pausado" ${t.estado==="Pausado"?"selected":""}>Pausado</option>
        <option value="Cerrado" ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
        <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
      </select><br><br>

      <label>Descripci√≥n</label>
      <textarea id='descripcion' placeholder='Descripci√≥n' rows="3" ${disabledCampos} style="resize:none; overflow:hidden;">${t.description ?? t.descripcion ?? ""}</textarea><br><br>

      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button onclick='guardarEdicion(${t.id})' class="btn">Guardar</button>
        <button onclick='cerrarModal()' class="btn" style="background:#6c757d;">Cancelar</button>
      </div>
    </div>`;
  modal.style.display = "block";
  setTimeout(() => autoResize(document.getElementById('descripcion')), 0);
}

async function guardarEdicion(id){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;

  const data = {
    fecha: document.getElementById('fecha').value || null,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value
  };

  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT',
    headers,
    body: JSON.stringify(data)
  });

  Object.assign(t, data);
  cerrarModal();
  cargarTickets();
}

/* ================== INICIO ================== */
cargarTitulo();
cargarTecnicos().then(() => {
  aplicarVista(); // establece clase .cards seg√∫n toggle y carga tickets
});
</script>

</body>
</html>
