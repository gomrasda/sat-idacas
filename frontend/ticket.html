<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tickets del Aviso</title>
<style>
:root {
  --b: #e9eef6;
  --bg: #f5f7fb;
  --ink: #1f2937;
  --muted: #6b7280;
  --chip: #eef2f7;
  --card-b: #cfd8e6;
  --alt-bg: #f6f8fb;
}
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
}
.container {
  max-width: 980px;
  margin: auto;
  padding: 16px;
}
h2 {
  margin: 6px 0 12px;
  text-align: center;
  font-size: 48px;
  font-weight: 700;
  text-transform: uppercase;
}
.btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 16px 20px;
  cursor: pointer;
  border-radius: 8px;
  font-size: 24px;
}
.btn:hover {
  background: #0056b3;
}
.table-wrap {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}
th, td {
  padding: 10px;
  border: 1px solid #ccc;
}
th {
  background: #f7f9fc;
  font-weight: 600;
}
td input, td select, td textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--b);
  border-radius: 8px;
}
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: #fff;
  border: 1px solid #ccc;
  padding: 20px;
  border-radius: 10px;
  z-index: 1000;
  width: 95%;
  max-width: 600px;
}
@media (max-width: 1024px) {
  thead { display: none; }
  #ticketsBody tr { border: 0; }
  #ticketsBody tr.r1, #ticketsBody tr.r2, #ticketsBody tr.r3, #ticketsBody tr.r4 {
    display: grid;
    gap: 10px;
    padding: 12px;
    background: #fff;
    border: 2px solid var(--card-b);
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
  }
  #ticketsBody tr.r1 { grid-template-columns: 1fr 1fr; }
  #ticketsBody tr.r2 { grid-template-columns: 1fr; }
  #ticketsBody tr.r3 { grid-template-columns: 1fr 1fr; }
  #ticketsBody tr.r4 { grid-template-columns: 0.6fr auto; }
  #ticketsBody td { display: flex; flex-direction: column; gap: 4px; border: 0; }
  #ticketsBody td::before {
    content: attr(data-label);
    font-weight: 600;
    font-size: 40px;
  }
  #ticketsBody td input,
  #ticketsBody td select,
  #ticketsBody td textarea,
  #ticketsBody td .chip {
    font-size: 40px !important;
  }
  #ticketsBody tr.r1 .chip { font-size: 40px; }
  #ticketsBody tr.r2 textarea,
  #ticketsBody tr.r2 textarea:disabled {
    min-height: 240px;
    font-size: 35px;
  }
  #ticketsBody tr.r3 td input {
    font-size: 40px;
    font-weight: 600;
  }
  #ticketsBody tr.r4 select {
    min-height: 70px;
    font-size: 40px;
  }
  #ticketsBody td.acciones {
    flex-direction: row;
    gap: 10px;
  }
  #ticketsBody td.acciones button {
    width: 52px;
    height: 52px;
    font-size: 40px;
  }
  .modal {
    width: 96%;
    max-width: none;
    font-size: 40px;
  }
  .modal input,
  .modal select,
  .modal textarea {
    font-size: 40px;
    padding: 14px;
  }
  .modal textarea { min-height: 200px; }
  .modal button {
    font-size: 40px;
    padding: 14px 28px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; margin-bottom:12px;">
    <button class="btn" id="btnNuevo" style="flex:1;">‚ûï Crear Ticket</button>
    <button class="btn" id="btnVolver" style="flex:1; background:#6c757d;">üîô Volver a Avisos</button>
  </div>
  <h2 id="tituloCliente">Tickets del Aviso</h2>
  <label>Filtrar por Estado:</label>
  <select id="filtroEstado">
    <option value="Todos">Todos</option>
    <option value="Pausado">Pausado</option>
    <option value="Cerrado">Cerrado</option>
    <option value="Facturado">Facturado</option>
  </select>
  <div class="table-wrap">
    <table>
      <tbody id="ticketsBody"></tbody>
    </table>
  </div>
</div>
<div id="modal" style="display:none;"></div>
<script>
const api = "https://sat-idacas.onrender.com/api";
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';
const headers = {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer ' + token
};
const urlParams = new URLSearchParams(window.location.search);
const avisoId = parseInt(urlParams.get('avisoId'), 10);
let tecnicos = [];
let ticketsLista = [];
async function apiFetch(url, options = {}) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(`API ${res.status}`);
  try { return await res.json(); } catch { return null; }
}
async function cargarTecnicos() {
  const usuarios = await apiFetch(api + '/usuarios', { headers });
  tecnicos = (usuarios || []).filter(u => u.rol.toLowerCase() === 't√©cnico' || u.rol.toLowerCase() === 'tecnico');
}
async function cargarTitulo(){
  try {
    const aviso = await apiFetch(`${api}/avisos/${avisoId}`, { headers });
    let titulo = aviso && aviso.cliente ? "Tickets de " + aviso.cliente : "Tickets del Aviso (ID: " + avisoId + ")";
    document.getElementById('tituloCliente').innerText = titulo.toUpperCase();
  } catch {
    document.getElementById('tituloCliente').innerText = ("Tickets del Aviso (ID: "+avisoId+")").toUpperCase();
  }
}
document.getElementById('btnNuevo').addEventListener('click', async () => {
  await cargarTecnicos();
  abrirModal();
});
document.getElementById('btnVolver').addEventListener('click', () => {
  window.location.href = 'index.html#avisos';
});
async function actualizarCampo(id, campo, valor){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;
  const payload = { ...t };
  payload[campo] = valor;
  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT', headers, body: JSON.stringify(payload)
  });
  Object.assign(t, payload);
}
async function cargarTickets() {
  const tickets = await apiFetch(`${api}/tickets?aviso_id=${avisoId}`, { headers });
  ticketsLista = tickets || [];
  const body = document.getElementById('ticketsBody');
  const filtro = document.getElementById('filtroEstado').value;
  body.innerHTML = "";
  const forceMobile = new URLSearchParams(location.search).get('mobile') === '1';
  const isMobile = forceMobile || window.matchMedia('(max-width: 1024px)').matches;
  const sorted = ticketsLista.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  sorted.filter(t => filtro === "Todos" || t.estado === filtro)
    .forEach((t, idx) => {
      const editable = t.estado === "Pausado";
      const disabledCampos = editable ? "" : "disabled";
      const fechaFormateada = t.fecha ? new Date(t.fecha).toLocaleDateString('es-ES') : "";
      const desc = (t.description ?? "");
      const alt = (idx % 2 ? ' alt' : '');
      if (!isMobile) {
        body.innerHTML += `<tr>
          <td>${fechaFormateada}</td>
          <td>${t.tecnico || ""}</td>
          <td><input type="number" value="${t.horas_totales||0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}></td>
          <td><input type="number" value="${t.precio_materiales||0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}></td>
          <td><select onchange="cambiarEstadoTicket(${t.id},this.value,this)">
            <option ${t.estado==="Pausado"?"selected":""}>Pausado</option>
            <option ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
            <option ${t.estado==="Facturado"?"selected":""}>Facturado</option>
          </select></td>
          <td><textarea onchange="actualizarCampo(${t.id},'description',this.value)" ${disabledCampos}>${desc}</textarea></td>
          <td><button onclick='editarTicket(${t.id})'>‚úèÔ∏è</button><button onclick="borrarTicket(${t.id})">üóëÔ∏è</button></td>
        </tr>`;
      } else {
        body.innerHTML += `
        <tr class="r1${alt}"><td data-label="Fecha"><span class="chip">${fechaFormateada}</span></td>
        <td data-label="T√©cnico"><span class="chip">${t.tecnico || ""}</span></td></tr>
        <tr class="r2${alt}"><td data-label="Descripci√≥n"><textarea onchange="actualizarCampo(${t.id},'description',this.value)" ${disabledCampos}>${desc}</textarea></td></tr>
        <tr class="r3${alt}"><td data-label="Horas"><input type="number" value="${t.horas_totales||0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}></td>
        <td data-label="Materiales"><input type="number" value="${t.precio_materiales||0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}></td></tr>
        <tr class="r4${alt}"><td data-label="Estado"><select onchange="cambiarEstadoTicket(${t.id},this.value,this)">
          <option ${t.estado==="Pausado"?"selected":""}>Pausado</option>
          <option ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
          <option ${t.estado==="Facturado"?"selected":""}>Facturado</option>
        </select></td>
        <td class="acciones"><button onclick='editarTicket(${t.id})'>‚úèÔ∏è</button><button onclick="borrarTicket(${t.id})">üóëÔ∏è</button></td></tr>`;
      }
    });
}
window.addEventListener('resize', () => { clearTimeout(window._rt); window._rt = setTimeout(cargarTickets,150); });
function abrirModal(){
  const modal = document.getElementById("modal");
  modal.innerHTML = `<div class='modal'>
    <h3>Nuevo Ticket</h3>
    <input id='fecha' type='date'><br>
    <select id='tecnico'>${tecnicos.map(t => `<option>${t.nombre}</option>`).join("")}</select><br>
    <input id='horas_totales' type='number'><br>
    <input id='precio_materiales' type='number'><br>
    <select id='estado'><option>Pausado</option><option>Cerrado</option><option>Facturado</option></select><br>
    <textarea id='descripcion'></textarea><br>
    <button onclick='guardarTicket()'>Guardar</button>
    <button onclick='cerrarModal()'>Cancelar</button>
  </div>`;
  modal.style.display = "block";
}
function cerrarModal(){ document.getElementById("modal").style.display = "none"; }
async function guardarTicket(){
  const data = {
    aviso_id: avisoId,
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value
  };
  await apiFetch(`${api}/tickets`, { method: 'POST', headers, body: JSON.stringify(data) });
  cerrarModal(); cargarTickets();
}
async function borrarTicket(id){
  if (confirm("¬øEliminar ticket?")) {
    await apiFetch(`${api}/tickets/${id}`, { method: 'DELETE', headers });
    cargarTickets();
  }
}
async function cambiarEstadoTicket(id, nuevoEstado, selectEl){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;
  if ((nuevoEstado === 'Cerrado' || nuevoEstado === 'Facturado') && (!t.horas_totales || t.horas_totales <= 0)) {
    alert('No puedes cerrar o facturar un ticket sin horas.');
    if (selectEl) selectEl.value = t.estado;
    return;
  }
  await apiFetch(`${api}/tickets/${id}/estado`, { method: 'PUT', headers, body: JSON.stringify({ estado: nuevoEstado }) });
  t.estado = nuevoEstado;
  cargarTickets();
}
async function editarTicket(id){
  await cargarTecnicos();
  const t = ticketsLista.find(ticket => ticket.id === id);
  if (!t) return;
  const modal = document.getElementById("modal");
  modal.innerHTML = `<div class='modal'>
    <h3>Editar Ticket</h3>
    <input id='fecha' type='date' value='${t.fecha || ""}'><br>
    <select id='tecnico'>${tecnicos.map(te => `<option ${te.nombre === t.tecnico ? 'selected' : ''}>${te.nombre}</option>`).join("")}</select><br>
    <input id='horas_totales' type='number' value='${t.horas_totales || 0}'><br>
    <input id='precio_materiales' type='number' value='${t.precio_materiales || 0}'><br>
    <select id='estado'><option ${t.estado==="Pausado"?"selected":""}>Pausado</option><option ${t.estado==="Cerrado"?"selected":""}>Cerrado</option><option ${t.estado==="Facturado"?"selected":""}>Facturado</option></select><br>
    <textarea id='descripcion'>${t.description || ""}</textarea><br>
    <button onclick='guardarEdicion(${t.id})'>Guardar</button>
    <button onclick='cerrarModal()'>Cancelar</button>
  </div>`;
  modal.style.display = "block";
}
async function guardarEdicion(id){
  const data = {
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value
  };
  await apiFetch(`${api}/tickets/${id}`, { method: 'PUT', headers, body: JSON.stringify(data) });
  cerrarModal(); cargarTickets();
}
cargarTitulo();
cargarTecnicos().then(cargarTickets);
</script>
</body>
</html>
