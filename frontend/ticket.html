<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tickets del Aviso</title>
  <style>
    :root{
      --b:#e9eef6; --bg:#f5f7fb; --ink:#1f2937; --muted:#6b7280; --chip:#eef2f7;
      --card-b:#cfd8e6; --alt-bg:#f6f8fb;
      /* Solo dos estados */
      --open:#0ea5e9;   /* Abierto (azul)  */
      --closed:#22c55e; /* Cerrado (verde) */
    }
    body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); }
    .container { max-width:980px; margin:auto; padding:16px; }
    h2 { margin-top:0; text-align:center; text-transform:uppercase; }
    label, select, input { display:block; width:100%; margin:10px 0; }
    .btn { background:#007bff; color:white; border:none; padding:14px 20px; cursor:pointer; border-radius:8px; font-size:18px; }
    .btn:hover { background:#0056b3; }
    .btn-grey { background:#6c757d; }
    .btn-grey:hover { background:#5a6268; }

    label { font-size:24px; font-weight:600; }

    .table-wrap { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:white; margin-top:20px; }
    th, td { padding:10px; border:1px solid #ccc; text-align:left; }
    th { background:#f7f9fc; font-weight:600; color:#4a5568; }

    td textarea{ resize:none; overflow:hidden; min-height:56px; line-height:1.4; width:100%; }

    .actions-row{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 8px 0 10px;
    }
    .actions-row .btn{
      width: 100%;
      text-align:center;
      font-size: 20px;
      padding: 14px 20px;
    }

    #resumen { display:flex; justify-content:space-between; align-items:center;
      font-size:24px; font-weight:700; color:#1f2937;
      margin:10px 0 20px; background:#eef2f7; padding:10px 14px; border-radius:8px;
    }

    body.cards thead{display:none;}
    body.cards #ticketsBody tr{border:0;}
    body.cards #ticketsBody tr.r1,
    body.cards #ticketsBody tr.r2,
    body.cards #ticketsBody tr.r3,
    body.cards #ticketsBody tr.r4{
      display:grid; gap:10px; padding:12px;
      background:#fff; border:2px solid var(--card-b);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    body.cards #ticketsBody tr.r1{ grid-template-columns:1fr 1fr; border-bottom:0; border-radius:12px 12px 0 0; margin-top:24px; align-items:center; }
    body.cards #ticketsBody tr.r2{ grid-template-columns:1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r3{ grid-template-columns:1fr 1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r4{ grid-template-columns:1fr 1fr; align-items:center; border-top:0; border-radius:0 0 12px 12px; margin-bottom:24px; }

    body.cards #ticketsBody td{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; padding:0; border:0; }
    body.cards #ticketsBody td::before{ content:attr(data-label); font-weight:600; color:#6b7280; font-size:14px; margin-bottom:2px; }

    .chip{ background:var(--chip); border:1px solid var(--b); padding:6px 10px; border-radius:999px; font-size:18px; white-space:nowrap; font-weight:600; }

    #ticketsBody tr.r2 textarea,
    #ticketsBody tr.r3 input,
    #ticketsBody tr.r4 select {
      font-size:18px !important;
      font-weight:600;
    }

    .estado select{ padding:10px 12px; border-radius:8px; color:#fff; width:100%; }
    .estado.open  select{ background:var(--open); }
    .estado.closed select{ background:var(--closed); }

    .acciones {
      display:flex !important;
      flex-direction:row !important;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .acciones button {
      width:52px; height:52px; font-size:28px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--b); background:#fff; border-radius:14px; cursor:pointer;
    }

    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; border:1px solid #ccc; padding:20px; border-radius:10px;
      z-index:1000; width:90%; max-width:420px;
    }
    .modal input, .modal select, .modal textarea { width:100%; margin:8px 0; padding:8px; }

    @media (max-width: 1024px){
      .container { max-width: 100%; padding: 12px; }
      #tituloCliente{ font-size: 54px !important; }
      label { font-size:35px !important; }
      #filtroEstado{ font-size: 40px !important; height: 64px; }
      .chip{ font-size: 40px; }
      #ticketsBody tr.r2 textarea,
      #ticketsBody tr.r3 input,
      #ticketsBody tr.r4 select {
        font-size: 40px !important;
        font-weight:600;
      }
      #ticketsBody tr.r2 textarea{ min-height: 220px; }
      .actions-row .btn { font-size: 36px; padding: 20px; }
      #resumen{ font-size:35px; }
      .acciones button{ width:70px; height:70px; font-size:40px; }

      body.cards #ticketsBody td.desc::before,
      body.cards #ticketsBody td.horas::before,
      body.cards #ticketsBody td.materiales::before,
      body.cards #ticketsBody td.estado::before {
        font-size:35px !important;
      }
    }
  </style>
</head>
<body class="cards">

<div class="container">
  <h2 id="tituloCliente">Tickets del Aviso</h2>

  <label>Filtrar por Estado:</label>
  <select id="filtroEstado" onchange="cargarTickets()">
    <option value="Todos">Todos</option>
    <option value="Abierto">Abierto</option>
    <option value="Cerrado">Cerrado</option>
  </select>

  <div class="actions-row">
    <button class="btn btn-grey" id="btnVolver">üîô Volver a Avisos</button>
    <button class="btn" id="btnNuevo">‚ûï Crear Ticket</button>
    <button class="btn" id="btnExportar">üìÑ Exportar Excel</button>
  </div>

  <div id="resumen">
    <span id="resumenHoras">Horas totales: 0</span>
    <span id="resumenMateriales">Materiales: 0 ‚Ç¨</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Fecha</th><th>T√©cnico</th><th>Horas</th><th>Materiales</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th></tr>
      </thead>
      <tbody id="ticketsBody"></tbody>
    </table>
  </div>
</div>

<div id="modal" style="display:none;"></div>

<script>
const api="https://sat-idacas.onrender.com/api",token=localStorage.getItem("token");
if(!token)location.href="login.html";
const headers={'Content-Type':'application/json','Authorization':'Bearer '+token};
const avisoId=new URLSearchParams(location.search).get("avisoId");
let tecnicos=[],ticketsLista=[];

async function apiFetch(u,o={}){const r=await fetch(u,o);if(!r.ok)throw new Error(r.status);try{return await r.json()}catch{return null}}
function autoResize(el){if(!el)return;el.style.height="auto";el.style.height=el.scrollHeight+"px";}
function ajustarTodos(){document.querySelectorAll("textarea").forEach(autoResize)}
document.addEventListener("input",e=>{if(e.target.tagName==="TEXTAREA")autoResize(e.target)})

// Cargar t√©cnicos
async function cargarTecnicos(){
  const u = await apiFetch(api + "/usuarios", { headers });
  const norm = s => (s ?? "").toString().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
  const hasTecRole = (user) => {
    const rRaw = user.rol ?? user.role ?? user.roles ?? "";
    const roles = Array.isArray(rRaw) ? rRaw : [rRaw];
    return roles.some(r => norm(r).includes("tecn"));
  };
  tecnicos = (u || [])
    .filter(hasTecRole)
    .map(t => ({ id: t.id ?? t._id ?? null, nombre: t.nombre ?? t.name ?? t.usuario ?? "Sin nombre" }));
}

async function cargarTitulo(){const a=await apiFetch(api+"/avisos/"+avisoId,{headers});tituloCliente.innerText=a?.cliente?`Tickets de ${a.cliente}`:`Tickets (ID:${avisoId})`}

// Botones
btnNuevo.onclick=async()=>{await cargarTecnicos();abrirModal()}
btnVolver.onclick=()=>location.href="index.html#avisos"

async function actualizarCampo(id,c,v){
  const t=ticketsLista.find(x=>x.id===id);if(!t)return;
  const p={...t};p[c]=c==="description"?v:+v||v;
  await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify(p)});
  Object.assign(t,p);actualizarResumen();
}

async function cargarTickets(){
  const ts=await apiFetch(api+"/tickets?aviso_id="+avisoId,{headers});
  ticketsLista=ts||[];const body=ticketsBody;body.innerHTML="";
  ts.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach((t,i)=>{
    // FILTRO: solo Abierto/Cerrado
    if(filtroEstado.value!=="Todos" && t.estado!==filtroEstado.value) return;

    // Solo editable si est√° Abierto
    const dis = t.estado==="Abierto" ? "" : "disabled";
    const f=t.fecha?new Date(t.fecha).toLocaleDateString("es-ES"):"";
    const d=t.description||"";
    const alt=i%2?" alt":"";

    const claseEstado = (t.estado==="Abierto") ? "open" : "closed";

    body.innerHTML+=`
      <tr class="r1${alt}"><td><span class="chip">${f}</span></td><td><span class="chip">${t.tecnico||""}</span></td></tr>
      <tr class="r2${alt}"><td class="desc" data-label="Descripci√≥n" style="grid-column:1/-1;"><textarea onchange="actualizarCampo(${t.id},'description',this.value)" ${dis}>${d}</textarea></td></tr>
      <tr class="r3${alt}"><td class="horas" data-label="Horas"><input type="number" value="${t.horas_totales||0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${dis}></td>
      <td class="materiales" data-label="Materiales"><input type="number" value="${t.precio_materiales||0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${dis}></td></tr>
      <tr class="r4${alt}">
        <td class="estado ${claseEstado}" data-label="Estado"><select onchange="cambiarEstadoTicket(${t.id},this.value,this)">
          <option value="Abierto"  ${t.estado==="Abierto"?"selected":""}>Abierto</option>
          <option value="Cerrado"  ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
        </select></td>
        <td class="acciones"><button onclick=editarTicket(${t.id})>‚úèÔ∏è</button><button onclick=borrarTicket(${t.id})>üóëÔ∏è</button></td>
      </tr>`;
  });ajustarTodos();actualizarResumen();
}

function actualizarResumen(){
  const h=ticketsLista.reduce((s,t)=>s+(+t.horas_totales||0),0);
  const m=ticketsLista.reduce((s,t)=>s+(+t.precio_materiales||0),0);
  resumenHoras.textContent="Horas totales: "+h;
  resumenMateriales.textContent="Materiales: "+m.toFixed(2)+" ‚Ç¨";
}

async function borrarTicket(id){if(confirm("¬øEliminar?")){await apiFetch(api+"/tickets/"+id,{method:"DELETE",headers});cargarTickets()}}

async function cambiarEstadoTicket(id,e,s){
  const t=ticketsLista.find(x=>x.id===id);if(!t)return;
  // Si cierras, exige horas > 0
  if(e==="Cerrado" && (!t.horas_totales || t.horas_totales<=0)){
    alert("Para cerrar, indica horas > 0"); s.value=t.estado; return;
  }
  await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify({...t,estado:e})});
  cargarTickets();
}

// Modal
function abrirModal(){
  const opciones = tecnicos.length
    ? tecnicos.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join("")
    : `<option value="">-- No hay t√©cnicos disponibles --</option>`;

  modal.innerHTML = `<div class=modal><h3>Nuevo Ticket</h3>
    <input id=fecha type=date>
    <select id=tecnico>${opciones}</select>
    <input id=horas_totales type=number>
    <input id=precio_materiales type=number>
    <select id=estado>
      <option>Abierto</option>
      <option>Cerrado</option>
    </select>
    <textarea id=descripcion></textarea>
    <button onclick=guardarTicket()>Guardar</button>
    <button onclick=cerrarModal()>Cancelar</button></div>`;
  modal.style.display = "block";
}

function cerrarModal(){modal.style.display="none"}

async function guardarTicket(){
  await apiFetch(api+"/tickets",{
    method:"POST",
    headers,
    body:JSON.stringify({
      aviso_id:avisoId,
      fecha:fecha.value,
      tecnico:tecnico.value,
      horas_totales:+horas_totales.value||0,
      precio_materiales:+precio_materiales.value||0,
      estado:estado.value,               // 'Abierto' | 'Cerrado'
      description:descripcion.value
    })
  });
  cerrarModal();cargarTickets();
}

async function editarTicket(id){
  const t=ticketsLista.find(x=>x.id===id);
  modal.innerHTML=`<div class=modal><h3>Editar</h3>
  <input id=fecha value="${t.fecha||''}">
  <input id=horas_totales type="number" value="${t.horas_totales||0}">
  <input id=precio_materiales type="number" value="${t.precio_materiales||0}">
  <select id=estado>
    <option ${t.estado==="Abierto"?"selected":""}>Abierto</option>
    <option ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
  </select>
  <textarea id=descripcion>${t.description||""}</textarea>
  <button onclick=guardarEdicion(${t.id})>Guardar</button><button onclick=cerrarModal()>Cancelar</button></div>`;
  modal.style.display="block";
}
async function guardarEdicion(id){
  const d={
    fecha:fecha.value,
    horas_totales:+horas_totales.value||0,
    precio_materiales:+precio_materiales.value||0,
    estado:estado.value,                 // 'Abierto' | 'Cerrado'
    description:descripcion.value
  };
  await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify(d)});
  cerrarModal();cargarTickets();
}

/* ===== Exportar a CSV (Excel) ===== */
function csvEscape(value){
  const s = (value ?? "").toString().replace(/\r?\n|\r/g, " ");
  return /[;"\t]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
}
function num(n){
  const v = typeof n === "number" ? n : parseFloat((n ?? "").toString().replace(",", "."));
  return isNaN(v) ? 0 : v;
}
function recogerDatosDeTickets(){
  const filtro = (document.getElementById("filtroEstado")?.value) || "Todos";
  return (ticketsLista || [])
    .filter(t => filtro === "Todos" || t.estado === filtro)
    .map(t => ({
      Fecha      : t.fecha ? new Date(t.fecha).toLocaleDateString("es-ES") : "",
      T√©cnico    : t.tecnico || "",
      Descripci√≥n: t.description || "",
      Horas      : num(t.horas_totales),
      Materiales : num(t.precio_materiales),
      Estado     : t.estado || ""
    }));
}
function construirCSV(rows){
  const SEP = ";";
  const head = ["Fecha","T√©cnico","Descripci√≥n","Horas","Materiales","Estado"];
  const lineas = [head.join(SEP)];

  rows.forEach(r=>{
    lineas.push([
      csvEscape(r.Fecha),
      csvEscape(r.T√©cnico),
      csvEscape(r.Descripci√≥n),
      r.Horas,
      r.Materiales,
      csvEscape(r.Estado)
    ].join(SEP));
  });

  const totHoras = rows.reduce((a,r)=>a + num(r.Horas), 0);
  const totMats  = rows.reduce((a,r)=>a + num(r.Materiales), 0);
  lineas.push(["","","Totales", totHoras, totMats, ""].join(SEP));

  const contenido = "\uFEFF" + lineas.join("\n"); // BOM UTF-8
  return new Blob([contenido], {type: "text/csv;charset=utf-8;"});
}
function exportarExcel(){
  const datos = recogerDatosDeTickets();
  if(!datos.length){ alert("No hay tickets para exportar."); return; }
  const blob = construirCSV(datos);
  const a = document.createElement("a");
  const id = new URLSearchParams(location.search).get("avisoId") || "sin_id";
  a.href = URL.createObjectURL(blob);
  a.download = `aviso_${id}_tickets.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}

// Click del bot√≥n Exportar
document.addEventListener("DOMContentLoaded", ()=>{
  const b = document.getElementById("btnExportar");
  if(b) b.addEventListener("click", exportarExcel);
});

/* ===== Fin exportaci√≥n ===== */

cargarTitulo();cargarTecnicos().then(cargarTickets);
</script>
</body>
</html>
