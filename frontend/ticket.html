<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tickets del Aviso</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { max-width: 600px; margin: auto; padding: 16px; }
    h2 { margin-top: 0; text-align: center; }
    label, select, input { display: block; width: 100%; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #e9ecef; }
    .btn { background: #007bff; color: white; border: none; padding: 10px 16px; margin-top: 10px; cursor: pointer; border-radius: 5px; }
    .btn:hover { background: #0056b3; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px; z-index: 1000; width: 90%; max-width: 400px; }
    .modal input, .modal select, .modal textarea { width: 100%; margin: 8px 0; padding: 8px; }
  </style>
</head>
<body>

<div class="container">
  <button onclick="window.location.href='index.html#avisos'" class="btn" style="background:#6c757d;">üîô Volver a Avisos</button>
  <h2 id="tituloCliente">Tickets del Aviso</h2>

  <label>Filtrar por Estado:</label>
  <select id="filtroEstado" onchange="cargarTickets()">
    <option value="Todos">Todos</option>
    <option value="Pausado">Pausado</option>
    <option value="Cerrado">Cerrado</option>
    <option value="Facturado">Facturado</option>
  </select>

  <button class="btn" id="btnNuevo">‚ûï Crear Ticket</button>

  <table>
    <thead>
      <tr><th>Fecha</th><th>T√©cnico</th><th>Horas</th><th>Materiales</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th></tr>
    </thead>
    <tbody id="ticketsBody"></tbody>
  </table>
</div>

<div id="modal" style="display:none;"></div>

<script>
const api = "https://sat-idacas.onrender.com/api";
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';

const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };

const params = new URLSearchParams(window.location.search);
const avisoId = parseInt(params.get('avisoId'), 10);

let tecnicos = [];
let ticketsLista = [];

// Helper opcional para ver errores de API
async function apiFetch(url, options){
  const res = await fetch(url, options);
  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    console.error('API error', res.status, url, txt);
    throw new Error(`API ${res.status}: ${url} -> ${txt}`);
  }
  try { return await res.json(); } catch { return null; }
}

async function cargarTecnicos() {
  const usuarios = await apiFetch(api + '/usuarios', { headers });
  tecnicos = (usuarios || []).filter(u => u.rol === 'T√©cnico' || u.rol === 'tecnico');
}

async function cargarTitulo(){
  try {
    const aviso = await apiFetch(`${api}/avisos/${avisoId}`, { headers });
    document.getElementById('tituloCliente').innerText =
      aviso && aviso.cliente ? ("Tickets de " + aviso.cliente) : ("Tickets del Aviso (ID: " + avisoId + ")");
  } catch(e){
    console.error("Error cargando t√≠tulo:", e);
    document.getElementById('tituloCliente').innerText = "Tickets del Aviso (ID: "+avisoId+")";
  }
}

document.getElementById('btnNuevo').addEventListener('click', async () => {
  await cargarTecnicos();
  abrirModal();
});

// Guarda un campo: siempre env√≠a el payload completo y sincroniza memoria
async function actualizarCampo(id, campo, valor){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;

  const payload = {
    fecha: t.fecha || null,
    tecnico: t.tecnico || "",
    horas_totales: Number(t.horas_totales) || 0,
    precio_materiales: Number(t.precio_materiales) || 0,
    estado: t.estado || "Pausado",
    description: t.description ?? t.descripcion ?? ""
  };

  if (['horas_totales','precio_materiales'].includes(campo)) {
    payload[campo] = parseFloat(valor) || 0;
  } else if (campo === 'description') {
    payload.description = (valor ?? "") + "";
  } else {
    payload[campo] = valor;
  }

  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT',
    headers,
    body: JSON.stringify(payload)
  });

  Object.assign(t, payload);
}

async function cargarTickets() {
  const tickets = await apiFetch(`${api}/tickets?aviso_id=${avisoId}`, { headers });
  ticketsLista = tickets || [];

  const body = document.getElementById('ticketsBody');
  const filtro = document.getElementById('filtroEstado').value;
  body.innerHTML = "";

  // Ordenar por fecha (descendente)
  const sorted = ticketsLista.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  sorted
    .filter(t => filtro === "Todos" || t.estado === filtro)
    .forEach(t => {
      // Solo editable en PAUSADO
      const disabledCampos = t.estado === "Pausado" ? "" : "disabled";
      const disabledEstado = ""; // estado siempre editable

      const fechaFormateada = t.fecha
        ? new Date(t.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })
        : "";

      body.innerHTML += `<tr>
        <td>${fechaFormateada}</td>
        <td>${t.tecnico}</td>
        <td><input data-field="horas_totales" type="number" value="${t.horas_totales || 0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}></td>
        <td><input data-field="precio_materiales" type="number" value="${t.precio_materiales || 0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}></td>
        <td>
          <select onchange="cambiarEstadoTicket(${t.id}, this.value, this)" ${disabledEstado}>
            <option value="Pausado"   ${t.estado==="Pausado"?"selected":""}>Pausado</option>
            <option value="Cerrado"   ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
            <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
          </select>
        </td>
        <td>
          <textarea
            data-field="description"
            onchange="actualizarCampo(${t.id},'description',this.value)"
            ${disabledCampos}
          >${t.description ?? t.descripcion ?? ""}</textarea>
        </td>
        <td>
          <button onclick='editarTicket(${t.id})'>‚úèÔ∏è</button>
          <button onclick="borrarTicket(${t.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
}

function abrirModal(){
  const modal = document.getElementById("modal");
  modal.innerHTML = `
    <div class='modal'>
      <h3>Nuevo Ticket</h3>
      <input id='fecha' type='date' required><br>
      <select id='tecnico'>
        ${tecnicos.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join("")}
      </select><br>
      <input id='horas_totales' type='number' placeholder='Horas Totales' min='0' step='0.1'><br>
      <input id='precio_materiales' type='number' placeholder='Precio Materiales' min='0' step='0.01'><br>
      <select id='estado'>
        <option value="Pausado">Pausado</option>
        <option value="Cerrado">Cerrado</option>
        <option value="Facturado">Facturado</option>
      </select><br><br>
      <textarea id='descripcion' placeholder='Descripci√≥n' rows="3"></textarea><br><br>
      <button onclick='guardarTicket()' class="btn">Guardar</button>
      <button onclick='cerrarModal()' class="btn" style="background:#6c757d;">Cancelar</button>
    </div>`;
  modal.style.display = "block";
}

function cerrarModal(){
  document.getElementById("modal").style.display = "none";
}

async function guardarTicket(){
  const data = {
    aviso_id: avisoId,
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value  // üëà clave correcta para backend
  };

  await apiFetch(`${api}/tickets`, {
    method: 'POST',
    headers,
    body: JSON.stringify(data)
  });
  cerrarModal();
  cargarTickets();
}

async function borrarTicket(id){
  if (confirm("¬øEliminar ticket?")) {
    await apiFetch(`${api}/tickets/${id}`, { method: 'DELETE', headers });
    cargarTickets();
  }
}

// Guarda todo antes de cambiar estado y valida horas>0 para Cerrar/Facturar
async function cambiarEstadoTicket(id, nuevoEstado, selectEl){
  try {
    const t = ticketsLista.find(x => x.id === id);
    if (!t) return;

    // leer valores visibles en la fila (si est√°n)
    let desc = t.description ?? t.descripcion ?? "";
    let horas = t.horas_totales ?? 0;
    let mats  = t.precio_materiales ?? 0;

    if (selectEl) {
      const tr    = selectEl.closest('tr');
      const dEl   = tr.querySelector('[data-field="description"]');
      const hEl   = tr.querySelector('[data-field="horas_totales"]');
      const mEl   = tr.querySelector('[data-field="precio_materiales"]');
      if (dEl) desc  = dEl.value ?? "";
      if (hEl) horas = parseFloat(hEl.value) || 0;
      if (mEl) mats  = parseFloat(mEl.value) || 0;
    }

    if ((nuevoEstado === 'Cerrado' || nuevoEstado === 'Facturado') && (!horas || horas <= 0)) {
      alert('No puedes cerrar o facturar un ticket sin horas.');
      if (selectEl) selectEl.value = t.estado;
      return;
    }

    // 1) Guardar TODO antes de cambiar estado (incluida description)
    const payload = {
      fecha: t.fecha || null,
      tecnico: t.tecnico || "",
      horas_totales: horas,
      precio_materiales: mats,
      estado: t.estado,       // a√∫n el anterior
      description: (desc ?? "") + ""
    };
    await apiFetch(`${api}/tickets/${id}`, {
      method: 'PUT',
      headers,
      body: JSON.stringify(payload)
    });
    Object.assign(t, payload);

    // 2) Cambiar estado
    await apiFetch(`${api}/tickets/${id}/estado`, {
      method: 'PUT',
      headers,
      body: JSON.stringify({ estado: nuevoEstado })
    });

  } catch (e) {
    alert('No se pudo cambiar el estado. Revisa la consola.');
    if (selectEl) {
      const t = ticketsLista.find(x => x.id === id);
      if (t) selectEl.value = t.estado;
    }
  } finally {
    cargarTickets();
  }
}

async function editarTicket(id) {
  await cargarTecnicos();
  const t = ticketsLista.find(ticket => ticket.id === id);
  if (!t) return alert("No se encontr√≥ el ticket");

  const esPausado = t.estado === 'Pausado';
  const disabledCampos = esPausado ? "" : "disabled";

  const modal = document.getElementById("modal");
  modal.innerHTML = `
    <div class='modal'>
      <h3>Editar Ticket</h3>
      <input id='fecha' type='date' value='${t.fecha}' ${disabledCampos}><br>
      <select id='tecnico' ${disabledCampos}>
        ${tecnicos.map(te => `<option value="${te.nombre}" ${te.nombre === t.tecnico ? 'selected' : ''}>${te.nombre}</option>`).join("")}
      </select><br>
      <input id='horas_totales' type='number' value='${t.horas_totales || 0}' min='0' step='0.1' ${disabledCampos}><br>
      <input id='precio_materiales' type='number' value='${t.precio_materiales || 0}' min='0' step='0.01' ${disabledCampos}><br>
      <select id='estado'>
        <option value="Pausado" ${t.estado==="Pausado"?"selected":""}>Pausado</option>
        <option value="Cerrado" ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
        <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
      </select><br><br>
      <textarea id='descripcion' placeholder='Descripci√≥n' rows="3" ${disabledCampos}>${t.description ?? t.descripcion ?? ""}</textarea><br><br>
      <button onclick='guardarEdicion(${t.id})' class="btn">Guardar</button>
      <button onclick='cerrarModal()' class="btn" style="background:#6c757d;">Cancelar</button>
    </div>`;
  modal.style.display = "block";
}

async function guardarEdicion(id){
  const data = {
    fecha: document.getElementById('fecha').value,
    tecnico: document.getElementById('tecnico').value,
    horas_totales: parseFloat(document.getElementById('horas_totales').value) || 0,
    precio_materiales: parseFloat(document.getElementById('precio_materiales').value) || 0,
    estado: document.getElementById('estado').value,
    description: document.getElementById('descripcion').value
  };
  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT',
    headers,
    body: JSON.stringify(data)
  });
  cerrarModal();
  cargarTickets();
}

cargarTitulo();
cargarTecnicos().then(cargarTickets);
</script>

</body>
</html>
