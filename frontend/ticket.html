<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tickets del Aviso</title>
  <style>
    :root{
      --b:#e9eef6; --bg:#f5f7fb; --ink:#1f2937; --muted:#6b7280; --chip:#eef2f7;
      --card-b:#cfd8e6; --alt-bg:#f6f8fb;
      --paused:#facc15; --closed:#22c55e; --billed:#3b82f6;
    }
    body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); }
    .container { max-width:980px; margin:auto; padding:16px; }
    h2 { margin-top:0; text-align:center; text-transform:uppercase; }
    label, select, input { display:block; width:100%; margin:10px 0; }
    .btn { background:#007bff; color:white; border:none; padding:14px 20px; cursor:pointer; border-radius:8px; font-size:18px; }
    .btn:hover { background:#0056b3; }
    .btn-grey { background:#6c757d; }
    .btn-grey:hover { background:#5a6268; }

    .table-wrap { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:white; margin-top:20px; }
    th, td { padding:10px; border:1px solid #ccc; text-align:left; }
    th { background:#f7f9fc; font-weight:600; color:#4a5568; }

    td textarea{ resize:none; overflow:hidden; min-height:56px; line-height:1.4; width:100%; }

    .actions-row{ display:flex; gap:12px; justify-content:space-between; margin:8px 0 10px; }
    .actions-row .btn { flex:1 1 50%; text-align:center; font-size:20px; }

    /* Resumen horas/materiales */
    #resumen { display:flex; justify-content:space-between; align-items:center;
      font-size:18px; font-weight:700; color:#1f2937;
      margin:10px 0 20px; background:#eef2f7; padding:10px 14px; border-radius:8px;
    }

    /* Vista Tarjetas */
    body.cards thead{display:none;}
    body.cards #ticketsBody tr{border:0;}
    body.cards #ticketsBody tr.r1,
    body.cards #ticketsBody tr.r2,
    body.cards #ticketsBody tr.r3,
    body.cards #ticketsBody tr.r4{
      display:grid; gap:10px; padding:12px;
      background:#fff; border:2px solid var(--card-b);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    body.cards #ticketsBody tr.r1{ grid-template-columns:1fr 1fr; border-bottom:0; border-radius:12px 12px 0 0; margin-top:14px; align-items:center; }
    body.cards #ticketsBody tr.r2{ grid-template-columns:1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r3{ grid-template-columns:1fr 1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r4{ grid-template-columns:1fr 1fr; align-items:center; border-top:0; border-radius:0 0 12px 12px; margin-bottom:14px; }

    body.cards #ticketsBody td{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; padding:0; border:0; }
    body.cards #ticketsBody td::before{ content:attr(data-label); font-weight:600; color:#6b7280; font-size:14px; margin-bottom:2px; }

    .chip{ background:var(--chip); border:1px solid var(--b); padding:6px 10px; border-radius:999px; font-size:18px; white-space:nowrap; font-weight:600; }

    /* Igualar tama√±os de letras */
    #ticketsBody tr.r2 textarea,
    #ticketsBody tr.r3 input,
    #ticketsBody tr.r4 select {
      font-size:18px !important;
      font-weight:600;
    }

    /* Estado con colores din√°micos */
    .estado select{ padding:10px 12px; border-radius:8px; color:#fff; width:100%; }
    .estado.paused select{ background:var(--paused); color:#000; }
    .estado.closed select{ background:var(--closed); }
    .estado.billed select{ background:var(--billed); }

    /* Acciones */
    .acciones { display:flex; flex-direction:row; gap:10px; justify-content:flex-end; align-items:center; width:100%; }
    .acciones button {
      width:52px; height:52px; font-size:28px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--b); background:#fff; border-radius:14px; cursor:pointer;
    }

    /* Modal */
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; border:1px solid #ccc; padding:20px; border-radius:10px;
      z-index:1000; width:90%; max-width:420px;
    }
    .modal input, .modal select, .modal textarea { width:100%; margin:8px 0; padding:8px; }

    /* ====== M√ìVIL ====== */
    @media (max-width: 1024px){
      .container { max-width: 100%; padding: 12px; }
      #tituloCliente{ font-size: 54px !important; }
      #filtroEstado{ font-size: 40px !important; height: 64px; }
      .chip{ font-size: 40px; }
      #ticketsBody tr.r2 textarea,
      #ticketsBody tr.r3 input,
      #ticketsBody tr.r4 select {
        font-size: 40px !important;
        font-weight:600;
      }
      #ticketsBody tr.r2 textarea{ min-height: 220px; }
      .actions-row .btn { font-size: 36px; padding: 20px; }
      #resumen{ font-size:32px; }
      .acciones button{ width:70px; height:70px; font-size:40px; }
    }
  </style>
</head>
<body class="cards">

<div class="container">
  <h2 id="tituloCliente">Tickets del Aviso</h2>

  <label>Filtrar por Estado:</label>
  <select id="filtroEstado" onchange="cargarTickets()">
    <option value="Todos">Todos</option>
    <option value="Pausado">Pausado</option>
    <option value="Cerrado">Cerrado</option>
    <option value="Facturado">Facturado</option>
  </select>

  <div class="actions-row">
    <button class="btn btn-grey" id="btnVolver">üîô Volver a Avisos</button>
    <button class="btn" id="btnNuevo">‚ûï Crear Ticket</button>
  </div>

  <div id="resumen">
    <span id="resumenHoras">Horas totales: 0</span>
    <span id="resumenMateriales">Materiales: 0 ‚Ç¨</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Fecha</th><th>T√©cnico</th><th>Horas</th><th>Materiales</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th></tr>
      </thead>
      <tbody id="ticketsBody"></tbody>
    </table>
  </div>
</div>

<div id="modal" style="display:none;"></div>

<script>
const api="https://sat-idacas.onrender.com/api",token=localStorage.getItem("token");
if(!token)location.href="login.html";
const headers={'Content-Type':'application/json','Authorization':'Bearer '+token};
const avisoId=new URLSearchParams(location.search).get("avisoId");
let tecnicos=[],ticketsLista=[];

async function apiFetch(u,o={}){const r=await fetch(u,o);if(!r.ok)throw new Error(r.status);try{return await r.json()}catch{return null}}
function autoResize(el){if(!el)return;el.style.height="auto";el.style.height=el.scrollHeight+"px";}
function ajustarTodos(){document.querySelectorAll("textarea").forEach(autoResize)}
document.addEventListener("input",e=>{if(e.target.tagName==="TEXTAREA")autoResize(e.target)})

async function cargarTecnicos(){const u=await apiFetch(api+"/usuarios",{headers});tecnicos=(u||[]).filter(x=>(x.rol||"").toLowerCase().includes("tec"))}
async function cargarTitulo(){const a=await apiFetch(api+"/avisos/"+avisoId,{headers});tituloCliente.innerText=a?.cliente?`Tickets de ${a.cliente}`:`Tickets (ID:${avisoId})`}
btnNuevo.onclick=async()=>{await cargarTecnicos();abrirModal()}
btnVolver.onclick=()=>location.href="index.html#avisos"

async function actualizarCampo(id,c,v){const t=ticketsLista.find(x=>x.id===id);if(!t)return;
  const p={...t};p[c]=c==="description"?v:+v||v;
  await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify(p)});
  Object.assign(t,p);actualizarResumen();}

async function cargarTickets(){
  const ts=await apiFetch(api+"/tickets?aviso_id="+avisoId,{headers});
  ticketsLista=ts||[];const body=ticketsBody;body.innerHTML="";
  ts.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach((t,i)=>{
    if(filtroEstado.value!=="Todos"&&t.estado!==filtroEstado.value)return;
    const dis=t.estado==="Pausado"?"":"disabled",f=t.fecha?new Date(t.fecha).toLocaleDateString("es-ES"):"",d=t.description||"",alt=i%2?" alt":"";
    let claseEstado=t.estado==="Pausado"?"paused":t.estado==="Cerrado"?"closed":"billed";
    body.innerHTML+=`
      <tr class="r1${alt}"><td><span class="chip">${f}</span></td><td><span class="chip">${t.tecnico||""}</span></td></tr>
      <tr class="r2${alt}"><td data-label="Descripci√≥n" style="grid-column:1/-1;"><textarea onchange="actualizarCampo(${t.id},'description',this.value)" ${dis}>${d}</textarea></td></tr>
      <tr class="r3${alt}"><td data-label="Horas"><input type="number" value="${t.horas_totales||0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${dis}></td>
      <td data-label="Materiales"><input type="number" value="${t.precio_materiales||0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${dis}></td></tr>
      <tr class="r4${alt}">
        <td class="estado ${claseEstado}" data-label="Estado"><select onchange="cambiarEstadoTicket(${t.id},this.value,this)">
          <option value="Pausado" ${t.estado==="Pausado"?"selected":""}>Pausado</option>
          <option value="Cerrado" ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
          <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
        </select></td>
        <td class="acciones"><button onclick=editarTicket(${t.id})>‚úèÔ∏è</button><button onclick=borrarTicket(${t.id})>üóëÔ∏è</button></td>
      </tr>`
  });ajustarTodos();actualizarResumen();
}

function actualizarResumen(){
  const h=ticketsLista.reduce((s,t)=>s+(+t.horas_totales||0),0);
  const m=ticketsLista.reduce((s,t)=>s+(+t.precio_materiales||0),0);
  resumenHoras.textContent="Horas totales: "+h;
  resumenMateriales.textContent="Materiales: "+m.toFixed(2)+" ‚Ç¨";
}

async function borrarTicket(id){if(confirm("¬øEliminar?")){await apiFetch(api+"/tickets/"+id,{method:"DELETE",headers});cargarTickets()}}
async function cambiarEstadoTicket(id,e,s){const t=ticketsLista.find(x=>x.id===id);if(!t)return;
  if((e==="Cerrado"||e==="Facturado")&&(!t.horas_totales||t.horas_totales<=0)){alert("Horas requeridas");s.value=t.estado;return}
  await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify({...t,estado:e})});
  cargarTickets();
}

function abrirModal(){modal.innerHTML=`<div class=modal><h3>Nuevo Ticket</h3>
  <input id=fecha type=date><select id=tecnico>${tecnicos.map(t=>`<option>${t.nombre}</option>`).join("")}</select>
  <input id=horas_totales type=number><input id=precio_materiales type=number>
  <select id=estado><option>Pausado</option><option>Cerrado</option><option>Facturado</option></select>
  <textarea id=descripcion></textarea>
  <button onclick=guardarTicket()>Guardar</button><button onclick=cerrarModal()>Cancelar</button></div>`;modal.style.display="block"}
function cerrarModal(){modal.style.display="none"}
async function guardarTicket(){await apiFetch(api+"/tickets",{method:"POST",headers,body:JSON.stringify({aviso_id:avisoId,fecha:fecha.value,tecnico:tecnico.value,horas_totales:+horas_totales.value||0,precio_materiales:+precio_materiales.value||0,estado:estado.value,description:descripcion.value})});cerrarModal();cargarTickets()}

async function editarTicket(id){const t=ticketsLista.find(x=>x.id===id);
  modal.innerHTML=`<div class=modal><h3>Editar</h3>
  <input id=fecha value="${t.fecha}"><input id=horas_totales value="${t.horas_totales}"><input id=precio_materiales value="${t.precio_materiales}">
  <select id=estado><option ${t.estado==="Pausado"?"selected":""}>Pausado</option><option ${t.estado==="Cerrado"?"selected":""}>Cerrado</option><option ${t.estado==="Facturado"?"selected":""}>Facturado</option></select>
  <textarea id=descripcion>${t.description||""}</textarea>
  <button onclick=guardarEdicion(${t.id})>Guardar</button><button onclick=cerrarModal()>Cancelar</button></div>`;modal.style.display="block"}
async function guardarEdicion(id){const d={fecha:fecha.value,horas_totales:+horas_totales.value||0,precio_materiales:+precio_materiales.value||0,estado:estado.value,description:descripcion.value};await apiFetch(api+"/tickets/"+id,{method:"PUT",headers,body:JSON.stringify(d)});cerrarModal();cargarTickets()}

cargarTitulo();cargarTecnicos().then(cargarTickets)
</script>
</body>
</html>
