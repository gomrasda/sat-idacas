<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tickets del Aviso</title>
  <style>
    :root{
      --b:#e9eef6; --bg:#f5f7fb; --ink:#1f2937; --muted:#6b7280; --chip:#eef2f7;
      --card-b:#cfd8e6; --alt-bg:#f6f8fb;
      --paused:#facc15; --closed:#22c55e; --billed:#3b82f6;
    }
    body { margin: 0; font-family: Arial, sans-serif; background: var(--bg); color: var(--ink); }
    .container { max-width: 980px; margin: auto; padding: 16px; }
    h2 { margin-top: 0; text-align: center; text-transform: uppercase; }
    label, select, input { display: block; width: 100%; margin: 10px 0; }
    .btn { background: #007bff; color: white; border: none; padding: 14px 20px; cursor: pointer; border-radius: 8px; font-size: 18px; }
    .btn:hover { background: #0056b3; }
    .btn-grey { background:#6c757d; }
    .btn-grey:hover { background:#5a6268; }

    .table-wrap { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow-x:auto; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #f7f9fc; font-weight: 600; color: #4a5568; }

    td textarea{ resize:none; overflow:hidden; min-height:56px; line-height:1.4; }

    .actions-row{
      display:flex; gap:12px; justify-content:space-between; margin:8px 0 10px;
    }
    .actions-row .btn { flex:1 1 50%; text-align:center; font-size:20px; }

    /* Resumen horas/materiales */
    #resumen {
      display:flex; justify-content:space-between; align-items:center;
      font-size:18px; font-weight:700; color:#1f2937;
      margin:10px 0 20px; background:#eef2f7; padding:10px 14px; border-radius:8px;
    }

    /* Vista Tarjetas */
    body.cards thead{display:none;}
    body.cards #ticketsBody tr{border:0;}
    body.cards #ticketsBody tr.r1,
    body.cards #ticketsBody tr.r2,
    body.cards #ticketsBody tr.r3,
    body.cards #ticketsBody tr.r4{
      display:grid; gap:10px; padding:12px;
      background:#fff; border:2px solid var(--card-b);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    body.cards #ticketsBody tr.r1{ grid-template-columns:1fr 1fr; border-bottom:0; border-radius:12px 12px 0 0; margin-top:14px; align-items:center; }
    body.cards #ticketsBody tr.r2{ grid-template-columns:1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r3{ grid-template-columns:1fr 1fr; border-top:0; border-bottom:0; }
    body.cards #ticketsBody tr.r4{ grid-template-columns:0.7fr auto; border-top:0; border-radius:0 0 12px 12px; margin-bottom:14px; }
    body.cards #ticketsBody td{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; padding:0; border:0; }
    body.cards #ticketsBody td::before{ content:attr(data-label); font-weight:600; color:#6b7280; font-size:14px; margin-bottom:2px; }

    .chip{ background:var(--chip); border:1px solid var(--b); padding:6px 10px; border-radius:999px; font-size:14px; white-space:nowrap; }

    /* Estado con colores */
    .estado select{ padding:8px 10px; border-radius:8px; }
    .estado select option[value="Pausado"]{ background:var(--paused); color:#000; }
    .estado select option[value="Cerrado"]{ background:var(--closed); color:#fff; }
    .estado select option[value="Facturado"]{ background:var(--billed); color:#fff; }

    /* Modal */
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px;
      z-index: 1000; width: 90%; max-width: 420px;
    }
    .modal input, .modal select, .modal textarea { width: 100%; margin: 8px 0; padding: 8px; }

    /* ====== M√ìVIL ====== */
    @media (max-width: 1024px){
      .container { max-width: 100%; padding: 12px; }
      #tituloCliente{ font-size: 54px !important; }
      #filtroEstado{ font-size: 40px !important; height: 64px; }
      .chip{ font-size: 32px; }
      #ticketsBody tr.r2 textarea{ font-size: 35px !important; min-height: 220px; }
      #ticketsBody tr.r3 input{ font-size: 32px !important; }
      .estado select{ font-size: 32px !important; }
      .actions-row .btn { font-size: 36px; padding: 20px; }
      #resumen{ font-size:32px; }
    }
  </style>
</head>
<body class="cards">

<div class="container">
  <h2 id="tituloCliente">Tickets del Aviso</h2>

  <label>Filtrar por Estado:</label>
  <select id="filtroEstado" onchange="cargarTickets()">
    <option value="Todos">Todos</option>
    <option value="Pausado">Pausado</option>
    <option value="Cerrado">Cerrado</option>
    <option value="Facturado">Facturado</option>
  </select>

  <div class="actions-row">
    <button class="btn btn-grey" id="btnVolver">üîô Volver a Avisos</button>
    <button class="btn" id="btnNuevo">‚ûï Crear Ticket</button>
  </div>

  <div id="resumen">
    <span id="resumenHoras">Horas totales: 0</span>
    <span id="resumenMateriales">Materiales: 0 ‚Ç¨</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Fecha</th><th>T√©cnico</th><th>Horas</th><th>Materiales</th><th>Estado</th><th>Descripci√≥n</th><th>Acciones</th></tr>
      </thead>
      <tbody id="ticketsBody"></tbody>
    </table>
  </div>
</div>

<div id="modal" style="display:none;"></div>

<script>
/* ================== API / AUTH ================== */
const api = "https://sat-idacas.onrender.com/api";
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';
const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
const urlParams = new URLSearchParams(window.location.search);
const avisoId = parseInt(urlParams.get('avisoId'), 10);

let tecnicos = [];
let ticketsLista = [];

/* ================== HELPERS ================== */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, options);
  if (!res.ok) {
    throw new Error(`API ${res.status}: ${url}`);
  }
  try { return await res.json(); } catch { return null; }
}

function autoResize(el){ if(!el)return; el.style.height="auto"; el.style.height=el.scrollHeight+"px"; }
function ajustarTodos(){ document.querySelectorAll("textarea").forEach(autoResize); }
document.addEventListener("input",e=>{ if(e.target.tagName==="TEXTAREA") autoResize(e.target) });

/* ================== INIT ================== */
async function cargarTecnicos() {
  const usuarios = await apiFetch(api + '/usuarios', { headers });
  tecnicos = (usuarios || []).filter(u => (u.rol||"").toLowerCase().includes("tec"));
}

async function cargarTitulo(){
  try {
    const aviso = await apiFetch(`${api}/avisos/${avisoId}`, { headers });
    tituloCliente.innerText = aviso?.cliente ? ("Tickets de " + aviso.cliente) : ("Tickets del Aviso (ID: " + avisoId + ")");
  } catch {
    tituloCliente.innerText = "Tickets del Aviso (ID: "+avisoId+")";
  }
}

btnNuevo.onclick = async()=>{ await cargarTecnicos(); abrirModal(); }
btnVolver.onclick = ()=> location.href = 'index.html#avisos';

/* ================== CAMPOS INLINE ================== */
async function actualizarCampo(id, campo, valor){
  const t = ticketsLista.find(x => x.id === id);
  if (!t) return;
  const payload = { ...t };
  if (campo==="description") payload.description = valor;
  else payload[campo] = parseFloat(valor)||0;
  await apiFetch(`${api}/tickets/${id}`, {
    method: 'PUT', headers, body: JSON.stringify(payload)
  });
  Object.assign(t, payload);
  actualizarResumen();
}

/* ================== RENDER ================== */
async function cargarTickets() {
  const tickets = await apiFetch(`${api}/tickets?aviso_id=${avisoId}`, { headers });
  ticketsLista = tickets || [];
  const body = document.getElementById('ticketsBody');
  const filtro = document.getElementById('filtroEstado').value;
  body.innerHTML = "";

  ticketsLista
    .slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))
    .filter(t => filtro==="Todos" || t.estado===filtro)
    .forEach((t, idx)=>{
      const editable = t.estado==="Pausado";
      const disabledCampos = editable ? "" : "disabled";
      const fecha = t.fecha ? new Date(t.fecha).toLocaleDateString('es-ES') : "";
      const desc = t.description ?? "";
      const alt = (idx%2?' alt':'');

      body.innerHTML+=`
        <tr class="r1${alt}"><td><span class="chip">${fecha}</span></td><td><span class="chip">${t.tecnico||""}</span></td></tr>
        <tr class="r2${alt}"><td data-label="Descripci√≥n"><textarea onchange="actualizarCampo(${t.id},'description',this.value)" ${disabledCampos}>${desc}</textarea></td></tr>
        <tr class="r3${alt}">
          <td data-label="Horas"><input type="number" value="${t.horas_totales||0}" onchange="actualizarCampo(${t.id},'horas_totales',this.value)" ${disabledCampos}></td>
          <td data-label="Materiales"><input type="number" value="${t.precio_materiales||0}" onchange="actualizarCampo(${t.id},'precio_materiales',this.value)" ${disabledCampos}></td>
        </tr>
        <tr class="r4${alt}">
          <td class="estado" data-label="Estado">
            <select onchange="cambiarEstadoTicket(${t.id}, this.value, this)">
              <option value="Pausado" ${t.estado==="Pausado"?"selected":""}>Pausado</option>
              <option value="Cerrado" ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
              <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
            </select>
          </td>
          <td class="acciones"><button onclick=editarTicket(${t.id})>‚úèÔ∏è</button><button onclick=borrarTicket(${t.id})>üóëÔ∏è</button></td>
        </tr>`;
    });
  ajustarTodos();
  actualizarResumen();
}

/* ================== RESUMEN ================== */
function actualizarResumen(){
  const horas = ticketsLista.reduce((s,t)=> s+(+t.horas_totales||0),0);
  const mats = ticketsLista.reduce((s,t)=> s+(+t.precio_materiales||0),0);
  resumenHoras.textContent="Horas totales: "+horas;
  resumenMateriales.textContent="Materiales: "+mats.toFixed(2)+" ‚Ç¨";
}

/* ================== CRUD ================== */
async function borrarTicket(id){
  if(confirm("¬øEliminar ticket?")){
    await apiFetch(`${api}/tickets/${id}`, { method:'DELETE', headers });
    cargarTickets();
  }
}

async function cambiarEstadoTicket(id,nuevo,sel){
  const t = ticketsLista.find(x=>x.id===id);
  if(!t)return;
  if((nuevo==="Cerrado"||nuevo==="Facturado")&&(!t.horas_totales||t.horas_totales<=0)){
    alert("No puedes cerrar o facturar sin horas");
    sel.value=t.estado;
    return;
  }
  await apiFetch(`${api}/tickets/${id}`, { method:"PUT", headers, body: JSON.stringify({...t, estado:nuevo}) });
  cargarTickets();
}

function abrirModal(){
  modal.innerHTML=`
    <div class='modal'>
      <h3>Nuevo Ticket</h3>
      <input id='fecha' type='date'>
      <select id='tecnico'>${tecnicos.map(t=>`<option>${t.nombre}</option>`).join("")}</select>
      <input id='horas_totales' type='number'><input id='precio_materiales' type='number'>
      <select id='estado'><option>Pausado</option><option>Cerrado</option><option>Facturado</option></select>
      <textarea id='descripcion'></textarea>
      <button onclick='guardarTicket()'>Guardar</button>
      <button onclick='cerrarModal()'>Cancelar</button>
    </div>`;
  modal.style.display="block";
}
function cerrarModal(){ modal.style.display="none"; }

async function guardarTicket(){
  const data={aviso_id:avisoId,fecha:fecha.value,tecnico:tecnico.value,horas_totales:+horas_totales.value||0,precio_materiales:+precio_materiales.value||0,estado:estado.value,description:descripcion.value};
  await apiFetch(`${api}/tickets`,{method:"POST",headers,body:JSON.stringify(data)});
  cerrarModal(); cargarTickets();
}

async function editarTicket(id){
  const t=ticketsLista.find(x=>x.id===id);
  modal.innerHTML=`
    <div class='modal'><h3>Editar</h3>
      <input id='fecha' type='date' value='${t.fecha??""}'>
      <input id='horas_totales' type='number' value='${t.horas_totales||0}'>
      <input id='precio_materiales' type='number' value='${t.precio_materiales||0}'>
      <select id='estado'>
        <option value="Pausado" ${t.estado==="Pausado"?"selected":""}>Pausado</option>
        <option value="Cerrado" ${t.estado==="Cerrado"?"selected":""}>Cerrado</option>
        <option value="Facturado" ${t.estado==="Facturado"?"selected":""}>Facturado</option>
      </select>
      <textarea id='descripcion'>${t.description||""}</textarea>
      <button onclick='guardarEdicion(${t.id})'>Guardar</button>
      <button onclick='cerrarModal()'>Cancelar</button>
    </div>`;
  modal.style.display="block";
}

async function guardarEdicion(id){
  const data={fecha:fecha.value,horas_totales:+horas_totales.value||0,precio_materiales:+precio_materiales.value||0,estado:estado.value,description:descripcion.value};
  await apiFetch(`${api}/tickets/${id}`,{method:"PUT",headers,body:JSON.stringify(data)});
  cerrarModal(); cargarTickets();
}

/* ================== INICIO ================== */
cargarTitulo();
cargarTecnicos().then(cargarTickets);
</script>
</body>
</html>
