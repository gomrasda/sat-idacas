<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SAT CRUD Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --b:#e9eef6; --bg:#f5f5f5; --ink:#1f2937; --chip:#eef2f7; --card-b:#cfd8e6;
      --primary:#007bff; --primary-h:#0056b3;
    }
    *{box-sizing:border-box}
    body { margin: 0; font-family: Arial, sans-serif; background: var(--bg); color: var(--ink); }

    .topbar { background:#003366; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:12px 16px; position:fixed; top:0; left:0; right:0; z-index:900 }
    .topbar h2 { margin:0 }
    .topbar button { background:none; border:0; color:#fff; font-size:2rem; cursor:pointer }

    .sidebar { position:fixed; top:0; left:-75%; width:75%; height:100%; background:#222; color:#fff; padding:40px; transition:.3s; z-index:1001 }
    .sidebar.active { left:0 }
    .sidebar button { display:block; width:100%; text-align:left; padding:20px; background:none; border:0; color:#fff; border-bottom:1px solid #444; margin:10px 0; font-size:1.5rem; cursor:pointer }
    .logout { background:#dc3545; border-radius:8px; margin-bottom:20px }

    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:1000 }
    .overlay.active { display:block }

    .main { padding:16px; margin-top:60px }

    #inicio{ min-height:calc(100vh - 60px); display:flex; flex-direction:column; justify-content:center; align-items:center; gap:14px }
    #inicio img{ width:220px; max-width:420px }

    .cards{ display:flex; flex-direction:column; gap:16px; margin-top:12px }
    .card{ background:#fff; border:1px solid var(--card-b); padding:14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06) }
    .card .title{ font-size:20px; font-weight:bold; margin-bottom:6px }
    .meta{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
    .meta span{ background:var(--chip); padding:6px 8px; border-radius:999px }
    .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px }
    .actions button{ padding:6px 10px; border:1px solid var(--b); border-radius:6px; background:#fff; cursor:pointer }
    .actions button:hover{ background:#f1f5fb }
    .danger{ color:#b91c1c; border-color:#f6c8ce }

    .section-actions{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px }
    .section-actions input{ padding:8px; border:1px solid var(--b); border-radius:6px; font-size:1rem }
    .primary-btn{ background:var(--primary); color:#fff; border:0; border-radius:6px; padding:8px 12px; cursor:pointer }
    .primary-btn:hover{ background:var(--primary-h) }
  </style>
</head>
<body>

  <div class="topbar">
    <button onclick="toggleSidebar()">☰</button>
    <h2>SAT Control</h2>
    <span></span>
  </div>

  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <button class="logout" onclick="logout()">Cerrar sesión</button>
    <button onclick="mostrar('usuarios')" id="btnUsuarios">Usuarios</button>
    <button onclick="mostrar('clientes')">Clientes</button>
    <button onclick="mostrar('avisos')">Avisos</button>
  </div>

  <div class="main">
    <div id="inicio">
      <img src="logo.jpg" alt="Logo de la empresa">
      <h2>Bienvenido a SAT Control</h2>
    </div>

    <div id="usuarios" style="display:none;">
      <h2>USUARIOS</h2>
      <div class="section-actions">
        <input id="filtroUsuario" type="text" placeholder="Buscar usuario..." oninput="filtrarUsuarios()">
        <button class="primary-btn" onclick="nuevoUsuario()">➕ Nuevo Usuario</button>
      </div>
      <div id="usuariosCards" class="cards"></div>
    </div>

    <div id="clientes" style="display:none;">
      <h2>CLIENTES</h2>
      <div class="section-actions">
        <input id="filtroCliente" type="text" placeholder="Buscar cliente..." oninput="filtrarClientes()">
        <button class="primary-btn" onclick="nuevoCliente()">➕ Nuevo Cliente</button>
      </div>
      <div id="clientesCards" class="cards"></div>
    </div>

    <div id="avisos" style="display:none;">
      <h2>AVISOS</h2>
      <div class="section-actions">
        <button class="primary-btn" onclick="nuevoAviso()">➕ Nuevo Aviso</button>
      </div>
      <div id="avisosCards" class="cards"></div>
    </div>
  </div>

<script>
  // ====== AUTH / CONFIG ======
  const token = localStorage.getItem('token');
  if (!token) location.href = 'login.html';
  const payload = JSON.parse(atob(token.split('.')[1] || 'e30='));
  const rol = payload.rol || 'Usuario';

  const api = "https://sat-idacas.onrender.com/api"; // Cambia si tus endpoints son diferentes
  const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };

  function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
  function logout(){ localStorage.removeItem('token'); location.href = 'login.html'; }
  if (rol !== "Gestor") document.getElementById('btnUsuarios').style.display = 'none';

  function mostrar(seccion){
    ['inicio','usuarios','clientes','avisos'].forEach(id => document.getElementById(id).style.display='none');
    document.getElementById(seccion).style.display='block';
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
    if (seccion==='usuarios') cargarUsuarios();
    if (seccion==='clientes') cargarClientes();
    if (seccion==='avisos'){ cargarClientes(true); cargarTecnicos(); cargarAvisos(); }
  }

  async function apiGet(path){ const r=await fetch(api+path,{headers}); if(!r.ok) throw Error(r.status); return r.json(); }
  async function apiSend(path,method,data){ const r=await fetch(api+path,{method,headers,body:data?JSON.stringify(data):null}); if(!r.ok) throw Error(r.status); return r.json(); }

  // ====== USUARIOS ======
  let USUARIOS=[];
  async function cargarUsuarios(){ const d=await apiGet('/usuarios'); USUARIOS=d; pintarUsuarios(); }
  function pintarUsuarios(){ const q=document.getElementById('filtroUsuario').value.toLowerCase(); const cont=document.getElementById('usuariosCards'); cont.innerHTML=''; USUARIOS.filter(u=>JSON.stringify(u).toLowerCase().includes(q)).forEach(u=>{ cont.innerHTML+=`<div class=\"card\"><div class=\"title\">${u.nombre||'Usuario'}</div><div class=\"meta\"><span>Email: ${u.email||''}</span><span>Rol: ${u.rol||''}</span></div><div class=\"actions\"><button onclick='editarUsuario(${JSON.stringify(u.id)})'>Editar</button><button class=\"danger\" onclick='eliminarUsuario(${JSON.stringify(u.id)})'>Eliminar</button></div></div>`; }); }
  function filtrarUsuarios(){ pintarUsuarios(); }
  function nuevoUsuario(){ alert('Implementa POST /usuarios'); }
  function editarUsuario(id){ alert('Implementa PUT /usuarios/'+id); }
  async function eliminarUsuario(id){ if(confirm('¿Eliminar usuario?')){ await apiSend('/usuarios/'+id,'DELETE'); cargarUsuarios(); } }

  // ====== CLIENTES ======
  let CLIENTES=[];
  async function cargarClientes(silencioso=false){ const d=await apiGet('/clientes'); CLIENTES=d; if(!silencioso) pintarClientes(); }
  function pintarClientes(){ const q=document.getElementById('filtroCliente').value.toLowerCase(); const cont=document.getElementById('clientesCards'); cont.innerHTML=''; CLIENTES.filter(c=>JSON.stringify(c).toLowerCase().includes(q)).forEach(c=>{ cont.innerHTML+=`<div class=\"card\"><div class=\"title\">${c.nombre||'Cliente'}</div><div class=\"meta\"><span>NIF: ${c.nif||''}</span><span>Tel: ${c.telefono||''}</span></div><div class=\"actions\"><button onclick='editarCliente(${JSON.stringify(c.id)})'>Editar</button><button class=\"danger\" onclick='eliminarCliente(${JSON.stringify(c.id)})'>Eliminar</button></div></div>`; }); }
  function filtrarClientes(){ pintarClientes(); }
  function nuevoCliente(){ alert('Implementa POST /clientes'); }
  function editarCliente(id){ alert('Implementa PUT /clientes/'+id); }
  async function eliminarCliente(id){ if(confirm('¿Eliminar cliente?')){ await apiSend('/clientes/'+id,'DELETE'); cargarClientes(); } }

  // ====== AVISOS ======
  let AVISOS=[], TECNICOS=[];
  async function cargarTecnicos(){ if(!USUARIOS.length) await cargarUsuarios(); TECNICOS=USUARIOS.filter(u=>(u.rol||'')==='Tecnico'); }
  async function cargarAvisos(){ const d=await apiGet('/avisos'); AVISOS=d; pintarAvisos(); }
  function pintarAvisos(){ const cont=document.getElementById('avisosCards'); cont.innerHTML=''; AVISOS.forEach(a=>{ cont.innerHTML+=`<div class=\"card\"><div class=\"title\">${a.titulo||'Aviso'}</div><div class=\"meta\"><span>Cliente: ${a.cliente_nombre||a.clienteId||''}</span><span>Estado: ${a.estado||'Pendiente'}</span></div><p>${a.descripcion||''}</p><div class=\"actions\"><button onclick='editarAviso(${JSON.stringify(a.id)})'>Editar</button><button class=\"danger\" onclick='eliminarAviso(${JSON.stringify(a.id)})'>Eliminar</button></div></div>`; }); }
  function nuevoAviso(){ alert('Implementa POST /avisos'); }
  function editarAviso(id){ alert('Implementa PUT /avisos/'+id); }
  async function eliminarAviso(id){ if(confirm('¿Eliminar aviso?')){ await apiSend('/avisos/'+id,'DELETE'); cargarAvisos(); } }

</script>
</body>
</html>
